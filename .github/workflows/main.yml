name: my Workflow
on: workflow_dispatch

permissions:
  id-token: write
  contents: read
jobs: 
  Terraform-init-plan: 
    runs-on: newrunner
    steps: 
    - name: Checkout
      uses: actions/checkout@v5.0.0
    - name: Azure Login
      uses: Azure/login@v2.3.0
      with:
        client-id: ed6631ca-0958-4f8f-a074-a4b34393002c
        tenant-id: e0eb0b0e-a455-477c-b0e8-56b7f7f4efb4
        subscription-id: 177b7e12-5f03-4f63-bcd1-ed6d1d776bff

    - name: Terraform fmt
      id: fmt
      run: terraform fmt -check
      continue-on-error: true
      working-directory: environments/dev
      
    - name: Terraform Init
      id: init
      run: terraform init -input=false  
      working-directory: environments/dev
      
    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
      working-directory: environments/dev        
          
    - name: Terraform Plan
      id: plan
      run: terraform plan -no-color -input=false
      continue-on-error: true
      working-directory: environments/dev 

  Terraform-apply:    
    runs-on: self-hosted
    needs: Terraform-init-plan
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
    
      - name: Azure Login
        uses: Azure/login@v2.3.0
        with:
           client-id: ed6631ca-0958-4f8f-a074-a4b34393002c
           tenant-id: e0eb0b0e-a455-477c-b0e8-56b7f7f4efb4
           subscription-id: 177b7e12-5f03-4f63-bcd1-ed6d1d776bff  
          
      - name: Terraform Init
        id: init
        run: terraform init -input=false  
        working-directory: environments/dev

      - name: Terraform Apply
        id: apply
        run: terraform apply --auto-approve
        continue-on-error: true
        working-directory: environments/dev      
      
